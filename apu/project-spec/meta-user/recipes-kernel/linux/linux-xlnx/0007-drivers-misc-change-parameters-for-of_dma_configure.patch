From 16d60e580b3fa70c9d5c661809e348101a9c6a9c Mon Sep 17 00:00:00 2001
From: Nagaradhesh Yeleswarapu <nagaradh@xilinx.com>
Date: Wed, 23 Jan 2019 12:07:46 +0530
Subject: [PATCH 07/11] drivers: misc: change parameters for of_dma_configure

change parameters for of_dma_configure.

Signed-off-by: Nagaradhesh Yeleswarapu <nagaradh@xilinx.com>
---
 drivers/misc/pl_mem.c | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/misc/pl_mem.c b/drivers/misc/pl_mem.c
index bab722fb37f1..bd0dc8613d41 100644
--- a/drivers/misc/pl_mem.c
+++ b/drivers/misc/pl_mem.c
@@ -582,7 +582,7 @@ static struct plmem_driver_data *plmem_driver_create(const char *name,
 	/* setup dma_dev */
 	this->dma_dev = parent;
 
-	of_dma_configure(this->dma_dev, NULL);
+	of_dma_configure(this->dma_dev, NULL, true);
 	dma_set_mask(this->dma_dev, DMA_BIT_MASK(sizeof(dma_addr_t) * 8));
 	dma_set_coherent_mask(this->dma_dev,
 			      DMA_BIT_MASK(sizeof(dma_addr_t) * 8));
@@ -820,11 +820,12 @@ static int plmem_platform_driver_probe(struct platform_device *pdev)
 	else
 		strcpy(channel, "adc");
 	/* create (plmem_driver_data*)this. */
-	driver_data = plmem_driver_create(DRIVER_NAME, &pdev->dev, minor_number,
-					  size, channel);
+	driver_data = plmem_driver_create(DRIVER_NAME, &pdev->dev,
+					  minor_number, size, channel);
 	if (IS_ERR_OR_NULL(driver_data)) {
 		dev_err(&pdev->dev, "driver create fail.\n");
 		retval = PTR_ERR(driver_data);
+		retval = -EPROBE_DEFER;
 		goto failed;
 	}
 	driver_data->is_dac = is_dac;
@@ -957,7 +958,7 @@ static int __init plmem_module_init(void)
 	return retval;
 }
 
-module_init(plmem_module_init);
+late_initcall(plmem_module_init);
 module_exit(plmem_module_exit);
 
 MODULE_AUTHOR("Xilinx, Inc.");
-- 
2.17.1

